# PR: C2後の品質安定化（落ちない・捏造しない・引用の出どころが追える）

## 目的

C2（実績DBのRAGで裏取り・引用強化）実装後の品質安定化を完了し、mainへマージできる状態にする。

主な目的：
- **落ちない**: 異常系でもアプリが落ちないようにエラーハンドリングを強化
- **捏造しない**: 引用の出どころを明確に表示し、検証可能にする
- **引用の出どころが追える**: 職務経歴書由来とRAG由来を区別表示

## 変更点

### 1. スモークテスト追加 (`chore/test`)

- **`scripts/smoke_test.py`**: 新規作成
  - `sample_inputs.md`からサンプルデータを自動読み込み
  - ケース1: RAGなしで分析実行、必須キーの存在をassert
  - ケース2: RAGありで分析実行、結果が返ることをassert
  - OPENAI_API_KEY未設定時は自動スキップ

- **`app.py`**: `run_analysis_core()`関数を追加
  - 分析処理をStreamlit UIから分離
  - 関数レベルで実行可能（スモークテストから呼び出し可能）

- **`README.md`**: スモークテストの実行方法を追記

### 2. 引用出どころ表示 (`feat/ui`)

- **`models.py`**:
  - `QuoteSource` Enum追加（`RESUME`, `RAG`）
  - `Quote`構造体追加（`text`, `source`, `source_id`）
  - `Evidence`を`quotes: List[Quote]`に変更（後方互換性維持）

- **`f2_extract_evidence.py`**:
  - `Quote`構造体を使用するように更新
  - RAG由来引用に`source_id`（チャンクインデックス）を付与
  - `_annotate_quote_sources()`で引用の出どころを記録

- **`app.py`**:
  - 引用表示時にラベルを付与
    - 📄 [職務経歴書]: 職務経歴書から直接抽出
    - 🔍 [実績DB]: 実績メモ（RAG検索）から抽出
    - 🔍 [実績DB #N]: 実績メモのN番目のチャンク由来

- **`README.md`**: 引用の表示ルールを追記

### 3. 異常系ハンドリング (`fix`)

- **`rag_error_handler.py`**: 新規作成
  - `validate_rag_inputs()`: RAG入力の検証
  - `handle_rag_initialization_error()`: RAG初期化エラーのハンドリング
  - `handle_rag_search_error()`: RAG検索エラーのハンドリング
  - `get_rag_status()`: RAG状態の取得（UI表示用）
  - ロガーを使用してエラーを記録

- **`f2_extract_evidence.py`**:
  - テキスト長制限を15,000文字に変更
  - 依存パッケージ不足、IOエラー、ベクトルストア初期化失敗を個別にハンドリング
  - エラーハンドリング共通関数を使用

- **`app.py`**:
  - 実績メモ入力時にOPENAI_API_KEYをチェック（`st.error + st.stop`）
  - 「🔍 RAG検索状態」expanderを追加（有効/無効/エラー/空）
  - 警告メッセージも表示

- **`README.md`**: 想定外ケースの挙動を追記

## 確認項目

### スモークテスト

```bash
# 仮想環境を有効化
source env/bin/activate  # macOS/Linux
# または
env\Scripts\activate  # Windows

# スモークテストを実行
python scripts/smoke_test.py
```

**期待される動作:**
- ケース1（RAGなし）: 必須キーが揃うことを確認 ✅
- ケース2（RAGあり）: OPENAI_API_KEYがあれば実行、なければスキップ ✅

### 引用出どころ表示

1. **通常モードで分析実行**
   - 引用にラベルが表示されることを確認
   - 📄 [職務経歴書] が表示されることを確認

2. **実績メモを入力してRAG検索を実行**
   - 🔍 [実績DB] または 🔍 [実績DB #N] が表示されることを確認
   - 職務経歴書と実績メモの両方に存在する場合、職務経歴書を優先表示

### 異常系ハンドリング

1. **実績メモが空**
   - RAG検索をスキップし、通常の根拠抽出のみ実行 ✅

2. **実績メモが長すぎる（15,000文字超）**
   - 警告を表示し、先頭15,000文字のみを使用 ✅
   - 処理は継続 ✅

3. **OPENAI_API_KEY未設定（実績メモ入力時）**
   - エラーメッセージを表示し、処理を停止 ✅
   - APIキーの設定方法を案内 ✅

4. **RAG初期化失敗**
   - エラーメッセージを表示し、RAG検索を無効化 ✅
   - 通常の根拠抽出は継続 ✅

5. **LLM出力パース失敗**
   - 最大3回リトライ ✅
   - それでも失敗した場合はフォールバック ✅

### RAG状態表示

- 「🔍 RAG検索状態」expanderが表示されることを確認
- 状態が正しく表示されることを確認（有効/無効/エラー/空）

## スクリーンショットの指示

以下のスクリーンショットを添付してください：

1. **引用出どころ表示**
   - 通常モードで分析実行後の引用表示部分
   - 📄 [職務経歴書] ラベルが表示されていること
   - 実績メモ入力時は 🔍 [実績DB] ラベルも表示されていること

2. **RAG状態表示**
   - 「🔍 RAG検索状態」expanderを展開した状態
   - 有効/無効/エラー/空のいずれかの状態が表示されていること

3. **異常系ハンドリング**
   - OPENAI_API_KEY未設定時のエラーメッセージ
   - 実績メモが長すぎる場合の警告メッセージ
   - RAG初期化失敗時のエラーメッセージ

## README更新内容の要点

### 追加されたセクション

1. **検証・テスト**
   - スモークテストの実行方法
   - テスト内容（ケース1/ケース2）
   - 注意事項（OPENAI_API_KEYの設定方法）

2. **引用の表示ルール**
   - 引用ラベルの種類（📄 [職務経歴書] / 🔍 [実績DB #N]）
   - 引用の優先順位
   - 後方互換性について

3. **想定外ケースの挙動**
   - 実績メモ関連の挙動
   - RAG初期化関連の挙動
   - LLM出力パース関連の挙動
   - RAG状態表示の説明
   - ログ出力の説明

### 更新されたセクション

1. **RAG（実績メモ検索）の仕様**
   - エラーハンドリング: テキスト長制限を15,000文字に更新
   - OPENAI_API_KEY未設定時の挙動を明確化

## ブランチ名

推奨ブランチ名: `feat/c2-hardening`

代替案:
- `feat/quality-stabilization`
- `feat/c2-quality-improvements`

## コミット分割

以下の3つのコミットに分割することを推奨：

1. `chore(test): add smoke test script for analysis core`
2. `feat(ui): add quote source tracking with Quote structure`
3. `fix: enhance error handling for RAG feature`

詳細は `COMMIT_PLAN.md` を参照してください。




