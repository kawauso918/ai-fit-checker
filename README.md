# AI応募適合度チェッカー

## 概要

AI応募適合度チェッカーは、求人票と職務経歴書を比較分析し、応募者の適合度を評価するアプリケーションです。AIを活用して、求人の要件と応募者の経験を詳細に照合し、客観的な評価を提供します。

## 主な機能

### 入力
- **求人票**: 募集要項、職務内容、必須スキル、歓迎スキルなどの情報
  - 通常モード：1つの求人票を分析
  - 比較モード：最大3つの求人票を同時に比較
- **職務経歴書**: 応募者の職務経歴書、スキル、経験などの情報
- **実績メモ（オプション）**: 追加の実績・経験を記載することで、根拠抽出の精度が向上
- **強調軸（オプション）**: 分析時に重視する観点（例：技術力、セキュリティ、LLM）

### 出力

#### 1. スコア評価
- **総合スコア**: Must要件70% + Want要件30%の加重平均
- **Mustスコア**: 必須要件の適合度（0-100点）
- **Wantスコア**: 歓迎要件の適合度（0-100点）
- **強調軸による加点**: 指定した観点に関連する要件に最大+10%相当の加点

#### 2. 差分サマリ
- **強みTop3**: マッチした要件から、confidence順・Must優先で上位3件を表示
- **致命的ギャップTop3**: ギャップのある要件から、Must優先で上位3件を表示

#### 3. 詳細分析（根拠表示改善）
- **Must/Wantセクション分け**: 要件をMust（必須）とWant（歓迎）でセクション分けして表示
- **マッチレベル表示**: 各要件にマッチレベルを表示
  - ✅ 完全一致（confidence >= 0.7）
  - ⚠️ 部分一致（0.4 <= confidence < 0.7）
  - ❌ ギャップ（confidence < 0.4 または引用なし）
- **マッチした要件**: 各要件に対する根拠、一致度、引用を表示
- **ギャップのある要件**: 不足している要件とその理由、改善の方向性を表示
- **引用検証**: 職務経歴書からの引用が実際に存在するか自動検証し、存在しない場合は警告表示
- **引用の出どころ表示**: 各引用にラベルを付与
  - 📄 [職務経歴書]: 職務経歴書から直接抽出された引用
  - 🔍 [実績DB]: 実績メモ（RAG検索）から抽出された引用
  - 🔍 [実績DB #N]: 実績メモのN番目のチャンク由来の引用（source_id付き）

#### 4. 改善案
- **全体戦略**: 改善の方向性を1〜2文で要約
- **職務経歴書の編集・追記案**: テンプレートと具体例をコピーしやすい形式で表示
- **行動計画**: 優先度別（A/B/C）に分類された具体的な行動提案

#### 5. 面接想定Q&A
- **質問10問程度**: 強み深掘り、ギャップ突っ込み、志望動機寄せの質問を生成
- **回答の骨子**: 各質問に対する回答の骨子を箇条書きで提示
- **捏造禁止**: 職務経歴にない内容は「学習中/計画」として回答

#### 6. 品質評価（LLM-as-Judge）
- **総合品質スコア**: 0-100点で評価
- **観点別スコア**: 根拠の妥当性、捏造リスクの低さ、具体性、実行可能性、一貫性、読みやすさの6観点
- **改善ポイント**: 優先度順に3つの改善提案

#### 7. Judge評価（3観点評価）
- **納得感**: ユーザーが判断しやすい構造・説明か（0-100点）
- **根拠の妥当性**: 引用が要件に適切に紐づいているか（0-100点）
- **誇張抑制**: 職務経歴にないことを断定していないか（0-100点）
- **問題点**: 優先度順に3つの問題点を指摘
- **改善提案**: 優先度順に3つの改善提案を提示

#### 8. 応募メール文面生成
- **件名**: 簡潔で目を引く件名（30文字以内推奨）
- **本文**: 応募の動機、職務経歴の要点、今後の意欲を含む文面
- **添付資料の提案**: 職務経歴書、ポートフォリオなど
- **送信時の注意点**: 誤字脱字チェック、送信前の確認事項など
- **企業情報対応**: 企業情報がある場合は、企業文化に合わせた文面を生成

#### 9. チャット機能
- **求人内容の深掘り考察**: 募集要件の詳細な解釈、仕事内容の理解促進
- **応募文面改善の提案**: 応募メール文面の改善点、職務経歴書の書き方アドバイス
- **面接対策の提案**: 面接で聞かれそうな質問への回答アドバイス
- **チャット履歴**: 会話履歴を保持し、継続的な対話が可能

#### 10. PDFエクスポート
- 分析結果をPDF形式でダウンロード可能
- スコア、サマリ、詳細分析、改善案、面接Q&Aを含む完全なレポート

#### 11. 複数求人票の比較（比較モード）
- 最大3つの求人票を同時に分析
- スコアランキング表示
- 各求人の詳細を折りたたみ表示

## 起動方法

### 1. 仮想環境の作成と有効化

```bash
python -m venv venv
source venv/bin/activate  # macOS/Linux
# または
venv\Scripts\activate  # Windows
```

### 2. 依存パッケージのインストール

```bash
pip install -r requirements.txt
```

### 3. 環境変数の設定

`.env`ファイルを作成し、以下の環境変数を設定してください：

```env
OPENAI_API_KEY=your_openai_api_key
# または
ANTHROPIC_API_KEY=your_anthropic_api_key
```

### 4. アプリケーションの起動

```bash
streamlit run app.py
```

ブラウザで自動的にアプリケーションが開きます。

## サンプルデータ

動作確認やテストに使用できるサンプルデータを用意しています。

### sample_data.py

以下のサンプルデータが含まれています：

**通常モード用**:
- `SAMPLE_JOB_TEXT`: Web系エンジニアの求人票
- `SAMPLE_RESUME_TEXT`: 5年経験のWebエンジニアの職務経歴書

**比較モード用**:
- `SAMPLE_JOB_TEXT_1`: スタートアップのフルスタックエンジニア募集
- `SAMPLE_JOB_TEXT_2`: 大手企業の社内システム開発エンジニア募集
- `SAMPLE_JOB_TEXT_3`: AI/機械学習エンジニア募集
- `SAMPLE_RESUME_TEXT_COMPARISON`: LLM経験を含む職務経歴書
- `SAMPLE_ACHIEVEMENT_NOTES`: 実績メモのサンプル
- `SAMPLE_EMPHASIS_AXES`: 企業タイプ別の推奨強調軸

### 使い方

```python
from sample_data import SAMPLE_JOB_TEXT_1, SAMPLE_JOB_TEXT_2, SAMPLE_JOB_TEXT_3
from sample_data import SAMPLE_RESUME_TEXT_COMPARISON

# コピーしてStreamlitアプリに貼り付け
print(SAMPLE_JOB_TEXT_1)  # 求人1
print(SAMPLE_JOB_TEXT_2)  # 求人2
print(SAMPLE_JOB_TEXT_3)  # 求人3
print(SAMPLE_RESUME_TEXT_COMPARISON)  # 職務経歴書
```

または、ファイルを直接開いてコピー＆ペーストすることもできます。

## 使用方法

### 基本的な使い方

1. **入力情報を入力**
   - 求人票のテキストを貼り付け
   - 職務経歴書のテキストを貼り付け

2. **オプション設定（任意）**
   - 志望職種を入力
   - 強調したい軸を入力（例：技術力、セキュリティ）
   - 実績メモを追加（根拠抽出の精度向上）

3. **分析を実行**
   - 「🚀 分析を実行」ボタンをクリック
   - F1〜F6の処理が順次実行されます

4. **結果を確認**
   - スコア、差分サマリ、詳細分析、改善案、面接Q&A、品質評価を確認
   - PDFレポートをダウンロード可能

### 比較モードの使い方

1. **比較モードを有効化**
   - 「🔀 比較モード（最大3つの求人票を比較）」にチェック

2. **複数の求人票を入力**
   - タブで求人1、求人2、求人3を入力

3. **分析を実行**
   - 各求人票に対して順次分析が実行されます

4. **比較結果を確認**
   - スコアランキングで上位順に表示
   - 各求人の詳細を折りたたみ表示

## 技術仕様

### 処理フロー

1. **F1: 求人要件抽出** - 求人票からMust/Want要件を抽出
2. **F2: 根拠抽出** - 職務経歴書から各要件に対する根拠を抽出
   - セクション分解による精度向上
   - RAG検索による実績メモからの根拠候補取得
3. **F3: スコア計算** - 適合度スコアを計算（強調軸による加点対応）
4. **F4: 改善案生成** - ギャップ分析から改善案を生成
5. **F5: 面接Q&A生成** - 分析結果から面接想定Q&Aを生成
6. **F6: 品質評価** - LLM-as-Judgeで出力品質を評価（6観点）
7. **F7: Judge評価** - LLM-as-Judgeで3観点評価（納得感/根拠の妥当性/誇張抑制）
8. **F8: 応募メール文面生成** - 求人票、職務経歴書、分析結果から応募メール文面を生成

### 使用技術

- **フレームワーク**: Streamlit
- **LLM**: OpenAI GPT-4o-mini / Anthropic Claude
- **ベクトルDB**: Chroma（RAG検索用）
- **PDF生成**: fpdf2
- **データモデル**: Pydantic v2

## 新機能（改善版）

### 根拠表示の改善
- **Must/Wantセクション分け**: 要件をMust（必須）とWant（歓迎）でセクション分けして表示
- **マッチレベル表示**: 完全一致/部分一致/ギャップを明確に表示
- **引用の出どころ追跡**: 各引用にラベルを付与し、職務経歴書由来かRAG由来かを区別

### Judge評価（3観点評価）
- **納得感**: ユーザーが判断しやすい構造・説明か
- **根拠の妥当性**: 引用が要件に適切に紐づいているか
- **誇張抑制**: 職務経歴にないことを断定していないか
- 問題点と改善提案を提示

### コスト最適化
- **miniモデルをデフォルト**: 通常生成はminiモデルを使用（コスト削減）
- **プロンプト圧縮**: 長いテキストは自動的に圧縮（先頭末尾の要点を残す）
- **候補文の制限**: 職務経歴が長い場合、候補文を上限30件に絞る

### 例外処理（入力検証）
- **求人票の検証**: 300文字未満の場合はエラーメッセージを表示
- **職務経歴の検証**: 200文字未満の場合はエラーメッセージを表示
- **要件抽出の検証**: 要件が抽出できない場合はエラーメッセージを表示
- **JSONパース失敗時のフォールバック**: リトライ後、フォールバックでテキスト整形して表示

## 注意事項

⚠️ **個人情報の取り扱いについて**

- 本アプリケーションを使用する際は、職務経歴書に含まれる個人情報（氏名、連絡先、住所など）をマスクすることを強く推奨します
- 機密情報や個人情報が含まれる可能性があるため、使用前に十分ご注意ください
- LLMを使用するため、入力データがAPI経由で送信されます

⚠️ **入力テキストの長さについて**

- **求人票・職務経歴書が短い場合（100文字未満）**: 分析は実行されますが、精度が低下する可能性があります
- より正確な分析のため、以下の情報を含むことを推奨します：
  - **求人票**: 募集要件・必須条件、歓迎要件・希望スキル、仕事内容・業務内容、必要な経験・スキル
  - **職務経歴書**: 担当業務・職務内容、使用技術・スキル、成果・実績、期間・在籍期間
- 空入力（空白のみ）の場合はエラーとなり、分析を実行できません

⚠️ **Judge評価について**

- Judge評価は参考情報として提供されます
- 評価結果はLLMの判断に基づくため、必ずしも正確とは限りません
- 最終的な判断はユーザー自身で行ってください

## 検証・テスト

### スモークテスト

基本的な動作確認を行うためのスモークテストスクリプトを用意しています。

```bash
# 仮想環境を有効化
source env/bin/activate  # macOS/Linux
# または
env\Scripts\activate  # Windows

# スモークテストを実行
python scripts/smoke_test.py
```

**テスト内容：**
- **ケース1（RAGなし）**: 実績メモなしで分析実行し、必須キーが揃うことを確認
- **ケース2（RAGあり）**: 短い実績メモを使用してRAG検索の動作確認

**注意事項：**
- ケース2のテストには`OPENAI_API_KEY`が必要です
  - 設定されていない場合は自動的にスキップされます
  - 実行方法: `export OPENAI_API_KEY=your_api_key` (macOS/Linux) または `set OPENAI_API_KEY=your_api_key` (Windows)
- テスト実行には数分かかる場合があります（LLM API呼び出しのため）
- `sample_inputs.md`からサンプルデータを自動的に読み込みます

## 引用の表示ルール

### 引用ラベルの種類

分析結果で表示される引用には、以下のラベルが付与されます：

- **📄 [職務経歴書]**: 職務経歴書から直接抽出された引用
- **🔍 [実績DB]**: 実績メモ（RAG検索）から抽出された引用（source_idが不明な場合）
- **🔍 [実績DB #N]**: 実績メモのN番目のチャンク由来の引用（source_idが特定できた場合）

### 引用の優先順位

1. 職務経歴書と実績メモの両方に存在する場合、職務経歴書を優先して表示
2. 実績メモのみに存在する場合、RAG由来として表示
3. 引用が原文に存在しない場合、「⚠️ 引用要確認」と表示

### 後方互換性

- RAGなし（実績メモ未入力）の場合、全ての引用は「📄 [職務経歴書]」として表示されます
- 既存の`resume_quotes`フィールドは後方互換性のため残されていますが、新規コードでは`quotes`フィールド（`Quote`構造体のリスト）を使用してください

## RAG（実績メモ検索）の仕様

### 概要

実績メモ機能は、職務経歴書に記載されていない追加の実績・経験をベクトル検索で活用し、根拠抽出の精度を向上させる機能です。

### 動作仕様

1. **入力**: 実績メモ（テキストエリアに入力）
2. **処理**:
   - テキストを500文字のチャンクに分割
   - OpenAI Embeddingsでベクトル化
   - Chroma（インメモリ）でベクトルストアを構築
   - 各要件の説明文をクエリとして類似度検索
   - 上位3件の候補をLLMプロンプトに追加
3. **出力**: 引用の出どころを区別表示
   - 📄 職務経歴書: 職務経歴書から直接抽出された引用
   - 🔍 実績メモ（RAG）: 実績メモから検索された引用

### 制限事項

- **テキスト長**: 最大10,000文字（超過分は自動カット）
- **チャンクサイズ**: 500文字（オーバーラップ100文字）
- **検索結果数**: 各要件あたり最大3件

### エラーハンドリング

以下の場合、RAG検索は自動的に無効化され、通常の根拠抽出にフォールバックします：

- `OPENAI_API_KEY`が設定されていない（実績メモ入力時は処理を停止）
- テキストが長すぎる（15,000文字超過）→ 先頭15,000文字のみ使用
- ベクトルストアの初期化に失敗（依存パッケージ不足、IOエラーなど）
- 検索処理中にエラーが発生

エラー発生時は警告メッセージが表示され、アプリケーションは継続して動作します。

## 想定外ケースの挙動

### 実績メモ関連

- **実績メモが空**: RAG検索をスキップし、通常の根拠抽出のみ実行
- **実績メモが長すぎる（15,000文字超）**: 
  - 警告を表示し、先頭15,000文字のみを使用
  - 処理は継続
- **OPENAI_API_KEY未設定（実績メモ入力時）**: 
  - エラーメッセージを表示し、処理を停止（`st.error + st.stop`）
  - APIキーの設定方法を案内

### RAG初期化関連

- **依存パッケージ不足**: 
  - エラーメッセージを表示し、RAG検索を無効化
  - 通常の根拠抽出は継続
- **ベクトルストア初期化失敗**: 
  - エラーメッセージを表示し、RAG検索を無効化
  - 通常の根拠抽出は継続
- **IOエラー**: 
  - エラーメッセージを表示し、RAG検索を無効化
  - 通常の根拠抽出は継続

### LLM出力パース関連

- **LLM出力パース失敗**: 
  - 最大3回リトライ
  - それでも失敗した場合は、ルールベースのフォールバック抽出を使用
  - 処理は継続（エラーはログに記録）

### RAG状態表示

分析実行後、「🔍 RAG検索状態」expanderで以下を確認できます：

- **有効**: RAG検索が正常に実行され、根拠候補を取得
- **無効**: 実績メモが空、またはAPIキー未設定
- **エラー**: RAG検索中にエラーが発生（処理は継続）
- **警告**: テキストが長すぎる場合など

### ログ出力

エラー発生時は、以下のログが出力されます：

- **INFO**: 通常の動作（RAG検索スキップなど）
- **WARNING**: 警告レベルのエラー（テキスト長超過など）
- **ERROR**: エラーレベルの問題（初期化失敗など）

ログは標準出力に出力され、開発時のデバッグに役立ちます。

## トラブルシューティング

### よくある問題

**Q: 引用が「⚠️引用要確認」と表示される**
- 職務経歴書からの引用が実際に存在しない可能性があります
- 引用が改行や空白の違いで検証に失敗している場合があります
- 引用の出どころ（📄 職務経歴書 / 🔍 実績メモ（RAG））を確認してください

**Q: 品質評価が表示されない**
- F6（品質評価）の実行に失敗した場合、スキップされます
- 分析結果は正常に表示されます

**Q: RAG検索が動作しない**
- 実績メモが入力されていることを確認してください
- OpenAI APIキーが正しく設定されていることを確認してください
- エラーメッセージが表示されている場合は、その内容を確認してください
- RAG検索が失敗しても、通常の根拠抽出は継続されます

**Q: PDFがダウンロードできない**
- ブラウザの設定を確認してください
- 日本語フォントの問題で一部の文字が正しく表示されない場合があります

**Q: 引用の出どころが表示されない**
- 引用の出どころは、RAG検索が有効な場合のみ区別表示されます
- 通常の根拠抽出では全て「📄 職務経歴書」として表示されます

